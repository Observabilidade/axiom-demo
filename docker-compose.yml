version: '3.2'

volumes:
  postgres_data:
  minio_data:
  secrets:
  logs:

services:
  postgres: 
    image: postgres:13-alpine
    environment:
      POSTGRES_USER: axiom
      POSTGRES_PASSWORD: axiom
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - logs:/usr/share/log
      - ./postgres/entrypoint.sh:/usr/local/bin/docker-entrypoint-override.sh
    entrypoint: ["/usr/local/bin/docker-entrypoint-override.sh"]
    command: ["postgres", "-c", "logging_collector=on", "-c", "log_statement=all", "-c", "log_directory=/usr/share/log/", "-c", "log_filename=postgres.log"]
  minio:
    image: minio/minio
    environment:
      MINIO_ACCESS_KEY: axiom
      MINIO_SECRET_KEY: axiomoixa
      MINIO_BROWSER: "on"
    entrypoint: sh
    command: -c 'mkdir -p /data/axiomdb && /usr/bin/minio server /data'
    ports:
      - 9000:9000
    volumes:
      - minio_data:/data
  axiom-db:
    image: axiomhq/axiom-db:1.3.0-rc.9
    environment:
      AXIOM_POSTGRES_URL: "postgres://axiom:axiom@postgres?sslmode=disable&connect_timeout=5"
      AXIOM_STORAGE: "minio://minio:9000/axiomdb/data?key=axiom&secret=axiomoixa&secure=false"
    depends_on:
      - minio
      - postgres
    restart: unless-stopped
  axiom-core:
    image: axiomhq/axiom-core:1.3.0-rc.9
    environment:
      AXIOM_POSTGRES_URL: "postgres://axiom:axiom@postgres?sslmode=disable&connect_timeout=5"
      AXIOM_DB_URL: "http://axiom-db"
    ports:
      - 8080:80
    depends_on:
      - axiom-db
    restart: unless-stopped
  setup:
    image: alpine:3
    volumes:
      - ./setup.sh:/usr/bin/setup
      - secrets:/usr/share/secrets
    command: ["/usr/bin/setup"]
  filebeat:
    image: docker.elastic.co/beats/filebeat-oss:7.10.2
    entrypoint: ["/usr/local/bin/docker-entrypoint-override.sh"]
    command: ["-environment", "container"]
    volumes:
      - secrets:/usr/share/secrets
      - logs:/usr/share/log:ro
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - ./filebeat/entrypoint.sh:/usr/local/bin/docker-entrypoint-override.sh
  metricbeat:
    image: docker.elastic.co/beats/metricbeat-oss:7.10.2
    entrypoint: ["/usr/local/bin/docker-entrypoint-override.sh"]
    command: ["-environment", "container"]
    environment:
      POSTGRES_URL: "postgres://axiom:axiom@postgres?sslmode=disable&connect_timeout=5"
    volumes:
      - secrets:/usr/share/secrets
      - ./metricbeat/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml
      - ./metricbeat/entrypoint.sh:/usr/local/bin/docker-entrypoint-override.sh
